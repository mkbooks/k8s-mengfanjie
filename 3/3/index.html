
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mkbooks.github.io/k8s-mengfanjie/3/3/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>高可用集群管理 - 云原生系列学习</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.975780f9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="None" data-md-color-accent="None">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="云原生系列学习" class="md-header__button md-logo" aria-label="云原生系列学习" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            云原生系列学习
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              高可用集群管理
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="云原生系列学习" class="md-nav__button md-logo" aria-label="云原生系列学习" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    云原生系列学习
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Go 语言基础
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Go 语言基础" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Go 语言基础
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/1/" class="md-nav__link">
        高可用微服务架构方法论
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_2" type="checkbox" id="__nav_1_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_2">
          Go 语言特性
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Go 语言特性" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_2">
          <span class="md-nav__icon md-icon"></span>
          Go 语言特性
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/2/1/" class="md-nav__link">
        为什么需要新的语言
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/2/2/" class="md-nav__link">
        Go 语言环境搭建
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/2/3/" class="md-nav__link">
        控制结构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/2/4/" class="md-nav__link">
        Go 语言常用数据结构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/2/5/" class="md-nav__link">
        Go 语言函数调用
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/2/6/" class="md-nav__link">
        常用语法
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_2_7" type="checkbox" id="__nav_1_2_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_2_7">
          多线程
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="多线程" data-md-level="3">
        <label class="md-nav__title" for="__nav_1_2_7">
          <span class="md-nav__icon md-icon"></span>
          多线程
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/2/7/" class="md-nav__link">
        基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/2/8/" class="md-nav__link">
        深入理解 channel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/2/9/" class="md-nav__link">
        基于 channel 编写一个生产者消费者程序
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1_3" type="checkbox" id="__nav_1_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1_3">
          Go 语言进阶
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Go 语言进阶" data-md-level="2">
        <label class="md-nav__title" for="__nav_1_3">
          <span class="md-nav__icon md-icon"></span>
          Go 语言进阶
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/3/1/" class="md-nav__link">
        线程加锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/3/2/" class="md-nav__link">
        线程调度
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/3/3/" class="md-nav__link">
        内存管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/3/4/" class="md-nav__link">
        包引用与依赖管理
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/3/5/" class="md-nav__link">
        Makefile
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/3/6/" class="md-nav__link">
        动手编写一个 HTTP Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/3/7/" class="md-nav__link">
        调试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/3/8/" class="md-nav__link">
        Kubernetes 中常用代码解读
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../1/3/9/" class="md-nav__link">
        Kubernetes 日常运维中的代码调试场景
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          云原生技术栈
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="云原生技术栈" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          云原生技术栈
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Docker 核心技术
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Docker 核心技术" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Docker 核心技术
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/1/1/" class="md-nav__link">
        从系统架构谈起
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/1/2/" class="md-nav__link">
        理解 Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/1/3/" class="md-nav__link">
        Dockerfile 的最佳实践
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Kubernetes 架构原则和对象设计
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Kubernetes 架构原则和对象设计" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes 架构原则和对象设计
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/2/1/" class="md-nav__link">
        云计算
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/2/2/" class="md-nav__link">
        Kubernetes 架构基础
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/2/3/" class="md-nav__link">
        了解 kubectl
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/2/4/" class="md-nav__link">
        深入理解 Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/2/5/" class="md-nav__link">
        核心对象概览
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../2/2/6/" class="md-nav__link">
        练习
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Kubernetes 控制平面组件
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Kubernetes 控制平面组件" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes 控制平面组件
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1" type="checkbox" id="__nav_3_1" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1">
          etcd
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="etcd" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          etcd
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1/" class="md-nav__link">
        etcd
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2/" class="md-nav__link">
        Raft协议
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          高可用集群管理
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        高可用集群管理
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    小练习
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd" class="md-nav__link">
    高可用etcd解决方案
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd-operator" class="md-nav__link">
    Etcd Operator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bitnami-etcd" class="md-nav__link">
    基于 Bitnami 安装 etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-etcd" class="md-nav__link">
    Kubernetes 如何使用 etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernets-etcd" class="md-nav__link">
    Kubernets 对象在 etcd 中的存储路径
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd_1" class="md-nav__link">
    etcd 在集群中所处的位置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-etcd_1" class="md-nav__link">
    Kubernetes 如何使用 etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd_2" class="md-nav__link">
    etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-etcd" class="md-nav__link">
    实践 - etcd 集群高可用
  </a>
  
    <nav class="md-nav" aria-label="实践 - etcd 集群高可用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#peer" class="md-nav__link">
    多少个 peer 最适合？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apiserver-etcd" class="md-nav__link">
    保证 apiserver 和 etcd 之间的高效性通讯
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-etcd_1" class="md-nav__link">
    实践 - etcd 存储规划
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd_3" class="md-nav__link">
    etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    减少网络延迟
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    减少磁盘 I/O 延迟
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    保持合理的日志文件大小
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    设置合理的存储配额
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    自动压缩历史版本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    定期消除碎片化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    优化运行参数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd_4" class="md-nav__link">
    etcd 备份存储
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    备份方案实践
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4/" class="md-nav__link">
        etcd常见问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_1_5" type="checkbox" id="__nav_3_1_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_1_5">
          练习
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="练习" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_1_5">
          <span class="md-nav__icon md-icon"></span>
          练习
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../test/etcd-ha-demo/install-ha-etcd/" class="md-nav__link">
        etcd-ha-demo
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../test/test/" class="md-nav__link">
        test
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2">
          API Server
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Server" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          API Server
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/0.overview/" class="md-nav__link">
        overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/1.%E8%AE%A4%E8%AF%81/" class="md-nav__link">
        认证
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/2.%E9%89%B4%E6%9D%83/" class="md-nav__link">
        鉴权
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/3.%E5%87%86%E5%85%A5/" class="md-nav__link">
        准入
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/4.%E9%99%90%E6%B5%81/" class="md-nav__link">
        限流
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/5.%E9%AB%98%E5%8F%AF%E7%94%A8APIServer/" class="md-nav__link">
        高可用APIServer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/6.apimachinery/" class="md-nav__link">
        apimachinery
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_8" type="checkbox" id="__nav_3_2_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_2_8">
          练习
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="练习" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_8">
          <span class="md-nav__icon md-icon"></span>
          练习
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/test/1.%E8%AE%A4%E8%AF%81%E7%BB%83%E4%B9%A0/" class="md-nav__link">
        认证练习
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/test/2.%E6%8E%88%E6%9D%83%E7%BB%83%E4%B9%A0/" class="md-nav__link">
        授权练习
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../4.kube-api-server/test/3.%E5%87%86%E5%85%A5%E7%BB%83%E4%B9%A0/" class="md-nav__link">
        准入练习
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3_3">
          调度器和控制器
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="调度器和控制器" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          调度器和控制器
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../5.%E8%B0%83%E5%BA%A6%E5%99%A8%E5%92%8C%E6%8E%A7%E5%88%B6%E5%99%A8/1.%E8%B0%83%E5%BA%A6/" class="md-nav__link">
        调度
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../5.%E8%B0%83%E5%BA%A6%E5%99%A8%E5%92%8C%E6%8E%A7%E5%88%B6%E5%99%A8/2.ControllerManager/" class="md-nav__link">
        Controller Manager
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../5.%E8%B0%83%E5%BA%A6%E5%99%A8%E5%92%8C%E6%8E%A7%E5%88%B6%E5%99%A8/3.kubelet/" class="md-nav__link">
        kubelet
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../5.%E8%B0%83%E5%BA%A6%E5%99%A8%E5%92%8C%E6%8E%A7%E5%88%B6%E5%99%A8/4.CRI/" class="md-nav__link">
        CRI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../5.%E8%B0%83%E5%BA%A6%E5%99%A8%E5%92%8C%E6%8E%A7%E5%88%B6%E5%99%A8/5.CNI/" class="md-nav__link">
        CNI
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../5.%E8%B0%83%E5%BA%A6%E5%99%A8%E5%92%8C%E6%8E%A7%E5%88%B6%E5%99%A8/6.CSI/" class="md-nav__link">
        CSI
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    小练习
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd" class="md-nav__link">
    高可用etcd解决方案
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd-operator" class="md-nav__link">
    Etcd Operator
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bitnami-etcd" class="md-nav__link">
    基于 Bitnami 安装 etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-etcd" class="md-nav__link">
    Kubernetes 如何使用 etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernets-etcd" class="md-nav__link">
    Kubernets 对象在 etcd 中的存储路径
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd_1" class="md-nav__link">
    etcd 在集群中所处的位置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kubernetes-etcd_1" class="md-nav__link">
    Kubernetes 如何使用 etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd_2" class="md-nav__link">
    etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-etcd" class="md-nav__link">
    实践 - etcd 集群高可用
  </a>
  
    <nav class="md-nav" aria-label="实践 - etcd 集群高可用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#peer" class="md-nav__link">
    多少个 peer 最适合？
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#apiserver-etcd" class="md-nav__link">
    保证 apiserver 和 etcd 之间的高效性通讯
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-etcd_1" class="md-nav__link">
    实践 - etcd 存储规划
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd_3" class="md-nav__link">
    etcd
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    减少网络延迟
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    减少磁盘 I/O 延迟
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    保持合理的日志文件大小
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    设置合理的存储配额
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    自动压缩历史版本
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    定期消除碎片化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    优化运行参数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#etcd_4" class="md-nav__link">
    etcd 备份存储
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    备份方案实践
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="_1">高可用集群管理</h1>
<h2 id="_2">小练习</h2>
<p>高可用 etcd 集群搭建</p>
<h2 id="etcd">高可用etcd解决方案</h2>
<p>etcd-operator: coreos 开源的, 基于 kubernetes CRD 完成 etcd 集群配置. Archived <a href="https//github.com/coreos/etcd-operator">https//github.com/coreos/etcd-operator</a></p>
<p>Etcd statefulset Helm chart: Bitnami(powered by vmware) <br>
<a href="https://bitnami.com/stack/etcd/helm">https://bitnami.com/stack/etcd/helm</a><br>
<a href="https://github.com/bitnami/charts/blob/master/bitnami/etcd">https://github.com/bitnami/charts/blob/master/bitnami/etcd</a><br></p>
<h2 id="etcd-operator">Etcd Operator</h2>
<p><img alt="Etcd-Operator" src="../images/Etcd-Operator.png" /></p>
<p><a href="https://github.com/coreos/etcd-operator.git">https://github.com/coreos/etcd-operator.git</a></p>
<h2 id="bitnami-etcd">基于 Bitnami 安装 etcd</h2>
<ul>
<li>安装 helm</li>
</ul>
<p><a href="https://github.com/helm/helm/releases">https://github.com/helm/helm/releases</a></p>
<ul>
<li>通过 helm 安装 etcd</li>
</ul>
<p>helm repo add bitnami <a href="https://charts.bitnami.com/bitnami">https://charts.bitnami.com/bitnami</a><br>
helm install my-release bitnami/etcd</p>
<ul>
<li>通过客户端与serve交互</li>
</ul>
<pre><code>kubectl run my-release-etcd-client --restart=,Never, --image docker.io/bitnami/etcd:3.5.0-debian-10-r94 --env ROOT_PASSWORD=$(kubectl get secret --namespace default my-release-etcd -o jsonpath=H(-data.etcd-root-password}H | base64 --decode) --env ETCDCTL_ENDPOINTS=&quot;my-release- etcd.default.svc.cluster.local:2379H --namespace default --command -- sleep infinity
</code></pre>
<h2 id="kubernetes-etcd">Kubernetes 如何使用 etcd</h2>
<p>etcd 是 kubernetes 的后端存储</p>
<p>对于每一个 kubernetes Object, 都有对应的 storage.go 负责对象的存储操作</p>
<ul>
<li>pkg/registry/core/pod/storage/storage.go</li>
</ul>
<p>API server启动脚本中指定etcd servers集群</p>
<pre><code>spec:
  containers:
  - command:
    - kube-apiserver
    - --advertise-address=192.168.34.2
    - --enable-bootstrap-token-auth=true
    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt
    - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt
    - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key
    - --etcd-servers=https://127.0.0.1:2379
</code></pre>
<p>早期 API server 对 etcd 做简单的 Ping check, 现在已经改为真实的 etcd api call</p>
<h2 id="kubernets-etcd">Kubernets 对象在 etcd 中的存储路径</h2>
<ul>
<li>ks exec -it etcd-cadmin sh</li>
<li>ETCDCTL_API=3</li>
</ul>
<pre><code>alias ectl='etcdctl —endpoints https://127.0.0.1:2379 \
--cacert /etc/kubernetes/pki/etcd/ca.crt \
--cert /etc/kubernetes/pki/etcd/server.crt \
--key /etc/kubernetes/pki/etcd/server.key'
</code></pre>
<pre><code>ectl get --prefix --keys-only /
/registry/namespaces/calico-apiserver 
/registry/networkpolicies/calico-apiserver/allow-apiserver 
/registry/operator.tigera.io/tigerastatuses/apiserver 
/registry/pops/calico-apiserver/calico-apiserver-77dffffcdf-g2tcx
/registry/pops/default/toolbox-68f79dd5f8-4664n
</code></pre>
<h2 id="etcd_1">etcd 在集群中所处的位置</h2>
<p><img alt="etcd在集群中所处的位置" src="../images/etcd%E5%9C%A8%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%89%80%E5%A4%84%E7%9A%84%E4%BD%8D%E7%BD%AE.png" /></p>
<h2 id="kubernetes-etcd_1">Kubernetes 如何使用 etcd</h2>
<p>etcd 是 kubernetes 的后端存储</p>
<p>对于每一个 kubernetes Object, 都有对应的 storage.go 负责对象的存储操作</p>
<ul>
<li>pkg/registry/core/pod/storage/storage.go</li>
</ul>
<p>API server启动脚本中指定 etcd servers 集群</p>
<ul>
<li><code>/usr/local/bin/kube-apiserver --etcd_servers=https://localhost:4001 --etcd- cafile=/etc/ssl/kubernetes/ca.crt--storage-backend=etcd3 --etcd-servers- overrides=/events#https://localhost:4002</code></li>
</ul>
<h2 id="etcd_2">etcd</h2>
<p>堆叠式 etcd 集群的高可用拓扑</p>
<ul>
<li>这种拓扑将相同节点上的控制平面和 etcd 成员耦合在一起. 优点在于建立起来非常容易, 并且对副本的管理也更容易. 但是, 堆叠式存在耦合失败的风险. 如果一个节点发生故障, 则 etcd 成员和控制平面实例都会丢失, 并且集群冗余也会受到损害. 可以通过添加更多控制平面节点来减轻这种风险. 因此为实现集群高可用应该至少运行三个堆叠的 Master 节点. 
<img alt="堆叠式etcd集群的高可用拓扑" src="../images/%E5%A0%86%E5%8F%A0etcd%E9%9B%86%E7%BE%A4.png" /></li>
</ul>
<p>外部 etcd 集群的高可用拓扑</p>
<ul>
<li>该拓扑将控制平面和 etcd 成员解耦. 如果丢失一个 Master 节点, 对 etcd 成员的影响较小, 并且不会像堆叠式拓扑那样对集群冗余产生太大影响. 但是, 此拓扑所需的主机数量是堆叠式拓扑的两倍. 具有此拓扑的群集至少需要三个主机用于控制平面节点, 三个主机用于 etcd 集群. </li>
</ul>
<p><img alt="外部etcd集群的高可用拓扑" src="../images/%E5%A4%96%E9%83%A8etcd%E9%9B%86%E7%BE%A4.png" /></p>
<h2 id="-etcd">实践 - etcd 集群高可用</h2>
<h3 id="peer">多少个 peer 最适合？</h3>
<ul>
<li>1个？3个？5个？</li>
<li>保证高可用是首要目标</li>
<li>所有写操作都要经过 leader</li>
<li>peer 多了是否能提升集群并读操作的并发能力？<ul>
<li>apiserver 的配置只连本地的 etcd peer</li>
<li>apiserver 的配置指定所有 etcd peers, 但只有当前连接的 etcd member 异常, apiserver才会换目标</li>
</ul>
</li>
<li>需要动态 flex up 吗？</li>
</ul>
<h3 id="apiserver-etcd">保证 apiserver 和 etcd 之间的高效性通讯</h3>
<ul>
<li>apiserver 和 etcd 部署在同一节点</li>
<li>apiserver 和 etcd 之间的通讯基于 gRPC<ul>
<li>针对每一个 object, apiserver 和 etcd 之间的 Connection -&gt; stream 共享</li>
<li>http2 的特性<ul>
<li>Stream quota</li>
<li>带来的问题？对于大规模集群, 会造成链路阻塞</li>
<li>10000个pod, —次 list 操作需要返回的数据可能超过 100M<ul>
<li>k get pod --all-namespaces|wc -L</li>
<li>8520</li>
<li>k get pod -oyaml --all-namespaces&gt;pops</li>
<li>Is -l pops</li>
<li>-rw-r--r-- 1 root root 75339736 Apr 5 03:13 pops</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="-etcd_1">实践 - etcd 存储规划</h2>
<p>本地VS远程？</p>
<ul>
<li>Remote Storage<ul>
<li>优势是假设永远可用, 现实真是如此吗?</li>
<li>劣势是 IO 效率, 可能带来的问题？</li>
</ul>
</li>
<li>最佳实践: <ul>
<li>Local SSD </li>
<li>利用 local volume 分配空间</li>
</ul>
</li>
<li>多少空间？<ul>
<li>与集群规模相关, 思考: 为什么每个 member 的 DB size 不一致?</li>
</ul>
</li>
</ul>
<p><img alt="存储规划" src="../images/etcd%E5%AD%98%E5%82%A8%E8%A7%84%E5%88%92.png" /></p>
<h2 id="etcd_3">etcd</h2>
<p>安全性</p>
<ul>
<li>peer 和 peer 之间的通讯加密<ul>
<li>是否有需求<ul>
<li>TLS 的额外开销</li>
<li>运营复杂度增加</li>
</ul>
</li>
</ul>
</li>
<li>数据加密<ul>
<li>是否有需求?</li>
<li>Kubernetes 提供了针对 secret 的加密<ul>
<li>https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>事件分离</p>
<ul>
<li>对于大规模集群, 大量的事件会对 etcd 造成压力</li>
<li>API server 启动脚本中指定 etcd server 集群<ul>
<li>/usr/local/bin/kube-apiserver —etcd_servers=https://localhost:4001 —etcd- cafile=/etc/ssl/kubernetes/ca.crt—storage-backend=etcd3 —etcd-servers- 
overrides=/events#https://localhost:4002</li>
</ul>
</li>
</ul>
<p>如何监控?</p>
<h2 id="_3">减少网络延迟</h2>
<p>减少网络延迟</p>
<ul>
<li>数据中心内的RTT大概是数毫秒, 国内的典型 RTT 约为 50ms, 两大洲之间的 RTT 可能慢至 400ms. 因此建议 etcd 集群尽量同地域部署. </li>
<li>当客户端到 Leader 的并发连接数量过多, 可能会导致其他 Follower 节点发往 Leader 的请求因 为网络拥塞而被延迟处理. 在 Follower 节点上, 可能会看到这样的错误: <ul>
<li>dropped MsgProp to 247ae21ff9436b2d since streamMsg's sending buffer is full</li>
</ul>
</li>
<li>可以在节点上通过流量控制工具 (Traffic Control) 提高 etcd 成员之间发送数据的优先级来避免. </li>
</ul>
<h2 id="io">减少磁盘 I/O 延迟</h2>
<p>对于磁盘延迟, 典型的旋转磁盘写延迟约为 10 毫秒. 对于 SSD  (Solid State Drives, 固态硬盘) ,  延迟通常低于1毫秒. HDD (Hard Disk Drive, 硬盘驱动器) 或者网盘在大量数据读写操作的情况下延时会不稳定. 因此强烈建议使用 SSD. </p>
<p>同时为了降低其他应用程序的 I/O 操作对 etcd 的干扰, 建议将 etcd 的数据存放在单独的磁盘内. 也可以将不同类型的对象存储在不同的若干个 etcd 集群中, 比如将频繁变更的 event 对象从主 etcd  集群中分离出来, 以保证主集群的高性能. 在 APIServer 处这是可以通过参数配置的. 这些 etcd 集 群最好也分别能有一块单独的存储磁盘. </p>
<p>如果不可避免地, etcd 和其他的业务共享存储磁盘, 那么就需要通过下面 ionice 命令对 etcd 服务 设置更高的磁盘 I/O 优先级, 尽可能避免其他进程的影响. </p>
<pre><code>$ ionice -c2 -n0 -p 'pgrep etcd'
</code></pre>
<h2 id="_4">保持合理的日志文件大小</h2>
<p>etcd以日志的形式保存数据, 无论是数据创建还是修改, 它都将操作追加到日志文件, 因此日志 文件大小会随着数据修改次数而线性增长. </p>
<p>当Kubernetes集群规模较大时, 其对etcd集群中的数据更改也会很频繁, 集群日记文件会迅速增长. </p>
<p>为了有效降低日志文件大小, etcd会以固定周期创建快照保存系统的当前状态, 并移除旧日志文件. 另外当修改次数累积到一定的数量 (默认是10000,通过参数"--snapshot-count"指定) , etcd也会创建快照文件. </p>
<p>如果etcd的内存使用和磁盘使用过高, 可以先分析是否数据写入频度过大导致快照频度过高, 确 认后可通过调低快照触发的阈值来降低其对内存和磁盘的使用. </p>
<h2 id="_5">设置合理的存储配额</h2>
<p>存储空间的配额用于控制 etcd 数据空间的大小. 合理的存储配额可保证集群操作的可靠性. 如果没有存储配额, 也就是 etcd 可以利用整个磁盘空间, etcd 的性能会因为存储空间的持续增长而严重下降, 甚至有耗完集群磁盘空间导致不可预测集群行为的风险. 如果设置的存储配额太小, 一旦其中一个节点的后台数据库的存储空间超出了存储配额, etcd 就会触发集群范围的告警, 并将集群置于只接受读和删除请求的维护模式. 只有在释放足够的空间、消除后端数据库的碎片和清 除存储配额告警之后, 集群才能恢复正常操作. </p>
<h2 id="_6">自动压缩历史版本</h2>
<p>etcd会为每个键都保存了历史版本. 为了避免出现性能问题或存储空间消耗完导致写不进去的问 题, 这些历史版本需要进行周期性地压缩. 压缩历史版本就是丢弃该键给定版本之前的所有信息, 节省出来的空间可以用于后续的写操作. etcd支持自动压缩历史版本. 在启动参数中指定参数"--auto-compaction", 其值以小时为单位. 也就是etcd会自动压缩该值设置的时间窗口之前的 历史版本. </p>
<h2 id="_7">定期消除碎片化</h2>
<p>压缩历史版本, 相当于离散地抹去etcd存储空间某些数据, etcd存储空间中将会出现碎片. 这些碎片无法被后台存储使用, 却仍占据节点的存储空间. 因此定期消除存储碎片, 将释放碎片化的存储空间, 重新调整整个存储空间. </p>
<ul>
<li>备份方案<ul>
<li>etcd 备份: 备份完整的集群信息, 灾难恢复<ul>
<li>etcdctl snapshot save</li>
</ul>
</li>
<li>基于事件重放<ul>
<li>备份 Kubernetes event</li>
</ul>
</li>
</ul>
</li>
<li>频度？<ul>
<li>时间间隔太长: <ul>
<li>能否接受user data lost?</li>
<li>如果有外部资源配置, 如负载均衡等, 能否接受数据丢失导致的 leak?</li>
</ul>
</li>
<li>时间间隔太短: <ul>
<li>对 etcd 的影响<ul>
<li>做 snapshot 的时候, etcd 会锁住当前数据</li>
<li>并发的写操作需要开辟新的空间进行增量写, 导致磁盘空间增长</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>如何保证备份的时效性, 同时防止磁盘爆掉？<ul>
<li>Auto defrag?</li>
</ul>
</li>
</ul>
<h2 id="_8">优化运行参数</h2>
<p>当网络延迟和磁盘延迟固定的情况下, 可以优化 etcd 运行参数来提升集群的工作效率. etcd 基于 Raft 协议进行 Leader 选举, 当 Leader 选定以后才能开始数据读写操作, 因此频繁的 Leader 选举会导致数据读写性能显著降低. 可以通过调整心跳周期(Heatbeat Interval) 和选举超时时间 (Election Timeout), 来降低 Leader 选举的可能性. </p>
<p>心跳周期是控制 Leader 以何种频度向 Follower 发起心跳通知. 心跳通知除表明 Leader 活跃状态之外,  还带有待写入数据信息, Follower 依据心跳信息进行数据写入, 默认心跳周期是100ms. 选举超时时间定义了当 Follower 多久没有收到 Leader 心跳, 则重新发起选举, 该参数的默认设置是 1000ms. </p>
<p>如果 etcd 集群的不同实例部署在延迟较低的相同数据中心, 通常使用默认配置即可. 如果不同实例部署在多数据中心或者网络延迟较高的集群环境, 则需要对心跳周期和选举超时时间进行调整. 建议心跳周期参数推荐设置为接近 etcd 多个成员之间平均数据往返周期的最大值, 一般是平均 RTT 的 0.55-1.5 倍.  如果心跳周期设置得过低, etcd 会发送很多不必要的心跳信息, 从而增加 CPU 和网络的负担. 如果设置 得过高, 则会导致选举频繁超时. 选举超时时间也需要根据 etcd 成员之间的平均 RTT 时间来设置. 选举超时时间最少设置为 etcd 成员之间 RTT 时间的 10 倍, 以便对网络波动. </p>
<p>心跳间隔和选举超时时间的值必须对同一个 etcd 集群的所有节点都生效, 如果各个节点配置不同, 就会导致集群成员之间协商结果不可预知而不稳定. </p>
<h2 id="etcd_4">etcd 备份存储</h2>
<p>etcd 的默认工作目录下会生成两个子目录: waf 和 snap. wal 是用于存放预写式日志, 其最大的作用是记录整个数据变化的全部历程. 所有数据的修改在提交前, 都要先写入 wal 中. </p>
<p>snap 是用于存放快照数据. 为防止 wal 文件过多, etcd 会定期 (当 wal 中数据超过 10000 条记录 时, 由参数"snapshot-count"设置) 创建快照. 当快照生成后, wal 中数据就可以被删除了. </p>
<p>如果数据遭到破坏或错误修改需要回滚到之前某个状态时, 方法就有两个: 一是从快照中恢复数据主体, 但是未被拍入快照的数据会丢失; 而是执行所有 WAL 中记录的修改操作, 从最原始的数据恢复到数据损坏之前的状态, 但恢复的时间较长. </p>
<h2 id="_9">备份方案实践</h2>
<p>官方推荐 etcd 集群的备份方式是定期创建快照. </p>
<p>根据集群对 etcd 备份粒度的要求, 可适当调节备份的周期. 在生产环境中实测, 拍摄快照通常会影响集群当时 的性能,因此不建议频繁创建快照. </p>
<p>但是备份周期太长, 就可能导致大量数据的丢失. </p>
<p>这里可以使用增量备份的方式. </p>
<p><img alt="备份方案实践" src="../images/%E5%A4%87%E4%BB%BD%E6%96%B9%E6%A1%88%E5%AE%9E%E8%B7%B5.png" /></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../2/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Raft协议" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Raft协议
            </div>
          </div>
        </a>
      
      
        
        <a href="../4/" class="md-footer__link md-footer__link--next" aria-label="Next: etcd常见问题" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              etcd常见问题
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.5a2dcb6a.min.js"></script>
      
    
    
  </body>
</html>